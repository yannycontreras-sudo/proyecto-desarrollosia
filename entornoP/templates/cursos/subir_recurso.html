{% extends "Base.html" %}
{% block content %}
<h2>Subir Recurso Multimedia</h2>

<form id="upload-form" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.as_p }}

  <div id="preview-container" style="display:none; border:1px solid #ddd; padding:12px; margin-top:12px;">
    <h3>Vista previa</h3>

    <img id="preview-image" src="" alt="Vista previa imagen" style="max-width:480px; display:none; margin-bottom:8px;">
    <video id="preview-video" controls style="max-width:640px; display:none; margin-bottom:8px;">
      <source id="preview-video-source" src="">
      Tu navegador no soporta video.
    </video>

    <div id="preview-doc" style="display:none; margin-bottom:8px;">
      <p>Documento: <a id="preview-doc-link" href="#" target="_blank">Abrir</a> | <a id="preview-doc-download" href="#" download>Descargar</a></p>
      <div id="preview-pdf-embed" style="display:none; margin-top:8px;">
        <iframe id="preview-pdf-iframe" src="" style="width:100%; height:600px; border:1px solid #ccc;"></iframe>
      </div>
    </div>

    <button id="remove-file-btn" type="button">Quitar archivo seleccionado</button>
  </div>

  <div style="margin-top:12px;">
    <button type="submit">Publicar</button>
  </div>

  {% if form.non_field_errors %}
    <div style="color:red;">{{ form.non_field_errors }}</div>
  {% endif %}
  {% for field in form %}
    {% for error in field.errors %}
      <div style="color:red;">{{ error }}</div>
    {% endfor %}
  {% endfor %}
</form>

<script>
(function(){
  const fileInput = document.querySelector('input[type="file"]');
  if (!fileInput) return;

  const previewContainer = document.getElementById('preview-container');
  const previewImage = document.getElementById('preview-image');
  const previewVideo = document.getElementById('preview-video');
  const previewVideoSource = document.getElementById('preview-video-source');
  const previewDoc = document.getElementById('preview-doc');
  const previewDocLink = document.getElementById('preview-doc-link');
  const previewDocDownload = document.getElementById('preview-doc-download');
  const previewPdfEmbed = document.getElementById('preview-pdf-embed');
  const previewPdfIframe = document.getElementById('preview-pdf-iframe');
  const removeBtn = document.getElementById('remove-file-btn');

  const imgExt = ['jpg','jpeg','png','gif','bmp','webp'];
  const vidExt = ['mp4','webm','ogg','mov'];
  const docExt = ['pdf','doc','docx','xls','xlsx','ppt','pptx','txt'];

  const MAX_MB = 50; // sincronizar con FILE_UPLOAD_MAX_MEMORY_SIZE en settings

  function resetPreview() {
    previewContainer.style.display = 'none';
    previewImage.style.display = 'none'; previewImage.src = '';
    previewVideo.style.display = 'none'; previewVideoSource.src = ''; previewVideo.load && previewVideo.load();
    previewDoc.style.display = 'none'; previewDocLink.href = '#'; previewDocDownload.href = '#';
    previewPdfEmbed.style.display = 'none'; previewPdfIframe.src = '';
  }

  fileInput.addEventListener('change', function(e){
    const f = e.target.files[0];
    if (!f) { resetPreview(); return; }

    if (f.size > MAX_MB * 1024 * 1024) {
      alert("El archivo supera el l√≠mite de " + MAX_MB + " MB.");
      fileInput.value = '';
      resetPreview();
      return;
    }

    const name = f.name;
    const ext = name.split('.').pop().toLowerCase();
    const url = URL.createObjectURL(f);

    resetPreview();
    previewContainer.style.display = 'block';

    if (imgExt.includes(ext)) {
      previewImage.src = url; previewImage.style.display = 'block';
      return;
    }

    if (vidExt.includes(ext)) {
      previewVideoSource.src = url;
      previewVideo.style.display = 'block';
      previewVideo.load();
      return;
    }

    previewDoc.style.display = 'block';
    previewDocLink.href = url; previewDocDownload.href = url;
    if (ext === 'pdf') {
      previewPdfEmbed.style.display = 'block';
      previewPdfIframe.src = url;
    } else {
      previewPdfEmbed.style.display = 'none';
    }
  });

  removeBtn && removeBtn.addEventListener('click', function(){
    fileInput.value = '';
    resetPreview();
  });
})();
</script>
{% endblock %}
