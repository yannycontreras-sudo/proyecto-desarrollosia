{% extends "Base.html" %}
{% block content %}
<h2>Subir Recurso Multimedia</h2>

<form method="POST" enctype="multipart/form-data">
  {% csrf_token %}

  {# renderiza los demás campos del form (modulo, titulo, tipo, etc) #}
  {{ form.modulo }}
  {{ form.titulo }}
  {{ form.tipo }}
  <!-- Asegúrate de renderizar SOLO el campo archivo aquí -->
  <label for="id_archivo">Archivo (imagen / video / documento):</label><br>
  {{ form.archivo }}  <!-- esto es IMPORTANTÍSIMO: usa el input del form -->
  <br><br>

  <!-- Contenedor de vista previa (inicialmente oculto) -->
  <div id="preview-container" style="display:none; border:1px solid #ddd; padding:12px; border-radius:6px;">
    <h4>Vista previa</h4>

    <img id="preview-image" src="" alt="preview imagen" style="max-width:480px; display:none; margin-bottom:8px;">
    
    <video id="preview-video" controls style="max-width:640px; display:none; margin-bottom:8px;">
      <source id="preview-video-source" src="">
      Tu navegador no soporta video.
    </video>

    <div id="preview-doc" style="display:none; margin-bottom:8px;">
      <p>Documento: <a id="preview-doc-link" href="#" target="_blank">Abrir</a> | <a id="preview-doc-download" href="#" download>Descargar</a></p>
      <div id="preview-pdf-embed" style="display:none; margin-top:8px;">
        <iframe id="preview-pdf-iframe" src="" style="width:100%; height:600px; border:1px solid #ccc;"></iframe>
      </div>
    </div>

    <button id="remove-file-btn" type="button">Quitar archivo seleccionado</button>
  </div>

  <div style="margin-top:12px;">
    <button type="submit">Publicar</button>
  </div>

  {# errores del form #}
  {{ form.non_field_errors }}
  {% for field in form %}
    {% for error in field.errors %}
      <div style="color:red;">{{ error }}</div>
    {% endfor %}
  {% endfor %}
</form>


<script>
(function(){
  // buscar el input file generado por Django (id normalmente "id_archivo" si tu campo se llama 'archivo')
  const fileInput = document.getElementById('id_archivo') || document.querySelector('input[type="file"][name$="archivo"]');
  if (!fileInput) return;

  const previewContainer = document.getElementById('preview-container');
  const imgEl = document.getElementById('preview-image');
  const videoEl = document.getElementById('preview-video');
  const videoSource = document.getElementById('preview-video-source');
  const docEl = document.getElementById('preview-doc');
  const docLink = document.getElementById('preview-doc-link');
  const docDownload = document.getElementById('preview-doc-download');
  const pdfEmbed = document.getElementById('preview-pdf-embed');
  const pdfIframe = document.getElementById('preview-pdf-iframe');
  const removeBtn = document.getElementById('remove-file-btn');

  const imgExt = ['jpg','jpeg','png','gif','bmp','webp'];
  const vidExt = ['mp4','webm','ogg','mov'];
  const MAX_MB = 50; // mantener consistente con settings

  function resetPreview(){
    previewContainer.style.display = 'none';
    imgEl.style.display = 'none'; imgEl.src = '';
    videoEl.style.display = 'none'; videoSource.src = ''; try{ videoEl.load(); }catch(e){}
    docEl.style.display = 'none'; docLink.href = '#'; docDownload.href = '#';
    pdfEmbed.style.display = 'none'; pdfIframe.src = '';
  }

  fileInput.addEventListener('change', function(e){
    const f = e.target.files[0];
    if(!f){ resetPreview(); return; }

    // tamaño en frontend (UX)
    if (f.size > MAX_MB * 1024 * 1024) {
      alert("El archivo supera el límite de " + MAX_MB + " MB.");
      fileInput.value = '';
      resetPreview();
      return;
    }

    const name = f.name || '';
    const ext = name.split('.').pop().toLowerCase();
    const url = URL.createObjectURL(f);

    // reset y mostrar contenedor
    resetPreview();
    previewContainer.style.display = 'block';

    if (imgExt.includes(ext) || f.type.startsWith('image/')) {
      imgEl.src = url;
      imgEl.style.display = 'block';
      return;
    }

    if (vidExt.includes(ext) || f.type.startsWith('video/')) {
      videoSource.src = url;
      videoEl.style.display = 'block';
      try{ videoEl.load(); }catch(e){}
      return;
    }

    // documento: enlazar y si pdf embeber
    docEl.style.display = 'block';
    docLink.href = url;
    docDownload.href = url;
    if (ext === 'pdf' || f.type === 'application/pdf') {
      pdfEmbed.style.display = 'block';
      pdfIframe.src = url;
    } else {
      pdfEmbed.style.display = 'none';
    }
  });

  removeBtn && removeBtn.addEventListener('click', function(){
    fileInput.value = '';
    resetPreview();
  });

})();
</script>

{% endblock %}
